{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport { _storeData, _retrieveData } from \"../utils/storage\";\nimport View from \"react-native-web/dist/exports/View\";\nimport * as React from 'react';\nimport { API_ENDPOINT } from \"../utils/constants\";\nimport axios from 'axios';\nimport UserNavigation from \"./userNavigation\";\nimport GuestNavigation from \"./guestNavigation\";\nimport { Button } from '@rneui/themed';\nimport { NavigationContainer } from '@react-navigation/native';\nimport { getUserInfo } from \"../API/getUserInfo\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nvar getSpotifyCredentials = function () {\n  var _ref = _asyncToGenerator(function* () {\n    var res = yield axios.get(API_ENDPOINT + '/api/spotify-credentials');\n    var spotifyCredentials = res.data;\n    return spotifyCredentials;\n  });\n  return function getSpotifyCredentials() {\n    return _ref.apply(this, arguments);\n  };\n}();\nvar refreshTokens = function () {\n  var _ref2 = _asyncToGenerator(function* (credentials, refreshToken) {\n    var credsB64 = btoa(credentials.clientId + \":\" + credentials.clientSecret);\n    var response = yield fetch('https://accounts.spotify.com/api/token', {\n      method: 'POST',\n      headers: {\n        Authorization: \"Basic \" + credsB64,\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: \"grant_type=refresh_token&refresh_token=\" + refreshToken\n    });\n    var responseJson = response.json();\n    return responseJson;\n  });\n  return function refreshTokens(_x, _x2) {\n    return _ref2.apply(this, arguments);\n  };\n}();\nexport default function Main() {\n  var _React$useState = React.useState(''),\n    _React$useState2 = _slicedToArray(_React$useState, 2),\n    accessToken = _React$useState2[0],\n    setAccessToken = _React$useState2[1];\n  var _React$useState3 = React.useState(''),\n    _React$useState4 = _slicedToArray(_React$useState3, 2),\n    refreshToken = _React$useState4[0],\n    setRefreshToken = _React$useState4[1];\n  var _React$useState5 = React.useState(0),\n    _React$useState6 = _slicedToArray(_React$useState5, 2),\n    expirationTime = _React$useState6[0],\n    setExpirationTime = _React$useState6[1];\n  var _React$useState7 = React.useState(true),\n    _React$useState8 = _slicedToArray(_React$useState7, 2),\n    loading = _React$useState8[0],\n    setLoading = _React$useState8[1];\n  function isExpired(expTime) {\n    if (new Date().getTime() > expTime) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n  var tokenRefreshWorkflow = function tokenRefreshWorkflow() {\n    try {\n      var accessTokenTemp = '';\n      var refreshTokenTemp = '';\n      var expirationTimeTemp = '';\n      _retrieveData('accessToken').then(function (aToken) {\n        accessTokenTemp = aToken;\n        _retrieveData('refreshToken').then(function (rToken) {\n          refreshTokenTemp = rToken;\n          _retrieveData('expirationTime').then(function (eTime) {\n            expirationTimeTemp = eTime;\n            console.log(\"hi?\");\n            if (accessTokenTemp && refreshTokenTemp && expirationTimeTemp) {\n              console.log(\"muaahhh\");\n              console.log(expirationTimeTemp);\n              console.log(\"REFRESH\");\n              console.log(refreshTokenTemp);\n              if (isExpired(expirationTimeTemp)) {\n                getSpotifyCredentials().then(function (credentials) {\n                  refreshTokens(credentials, refreshTokenTemp).then(function (responseJson) {\n                    console.log(\"Response JSON\");\n                    console.log(responseJson);\n                    if (Object.keys(responseJson).includes(\"expires_in\")) {\n                      if (responseJson[\"expires_in\"]) {\n                        var accessTokenNew = responseJson.access_token,\n                          refreshTokenNew = responseJson.refresh_token,\n                          expiresInNew = responseJson.expires_in;\n                        var expirationTimeNew = new Date().getTime() + expiresInNew * 1000;\n                        _storeData('accessToken', accessTokenNew);\n                        _storeData('refreshToken', refreshTokenNew);\n                        _storeData('expirationTime', expirationTimeNew);\n                        setAccessToken(accessTokenTemp);\n                        setRefreshToken(refreshTokenTemp);\n                        setExpirationTime(expirationTimeTemp);\n                        setLoading(false);\n                        console.log(\"loading?\");\n                        getUserInfo(accessTokenTemp).then(function (userInfo) {\n                          console.log(userInfo);\n                        });\n                        return true;\n                      }\n                    } else {\n                      setLoading(false);\n                    }\n                  });\n                });\n              } else {\n                getUserInfo(accessTokenTemp).then(function (userInfo) {\n                  console.log(userInfo);\n                });\n                if (accessTokenTemp !== accessToken) {\n                  setAccessToken(accessTokenTemp);\n                }\n                if (refreshToken !== refreshTokenTemp) {\n                  setRefreshToken(refreshTokenTemp);\n                }\n                if (expirationTime !== expirationTimeTemp) {\n                  setExpirationTime(expirationTimeTemp);\n                }\n                setLoading(false);\n                console.log(\"loading?\");\n                return true;\n              }\n            } else {\n              setLoading(false);\n            }\n          });\n        });\n      });\n    } catch (err) {\n      setLoading(false);\n      return false;\n    }\n  };\n  React.useEffect(function () {\n    console.log(\"MAIN USE EFFECT BEING CALLED\");\n    tokenRefreshWorkflow();\n  }, []);\n  var logOutUser = function logOutUser() {\n    _storeData('accessToken', '');\n    _storeData('refreshToken', '');\n    _storeData('expirationTime', '');\n    setAccessToken('');\n    setRefreshToken('');\n    setExpirationTime(0);\n  };\n  return _jsxs(NavigationContainer, {\n    children: [accessToken && refreshToken && expirationTime && !loading && _jsx(UserNavigation, {\n      logOutUser: logOutUser\n    }), !accessToken && isExpired(expirationTime) && !loading && _jsx(GuestNavigation, {\n      setAccessToken: setAccessToken,\n      setRefreshToken: setRefreshToken,\n      setExpirationTime: setExpirationTime\n    }), loading && _jsx(View, {\n      children: _jsx(\"h1\", {\n        children: \"Loading.....\"\n      })\n    })]\n  });\n}","map":{"version":3,"names":["_storeData","_retrieveData","React","API_ENDPOINT","axios","UserNavigation","GuestNavigation","Button","NavigationContainer","getUserInfo","getSpotifyCredentials","res","get","spotifyCredentials","data","refreshTokens","credentials","refreshToken","credsB64","btoa","clientId","clientSecret","response","fetch","method","headers","Authorization","body","responseJson","json","Main","useState","accessToken","setAccessToken","setRefreshToken","expirationTime","setExpirationTime","loading","setLoading","isExpired","expTime","Date","getTime","tokenRefreshWorkflow","accessTokenTemp","refreshTokenTemp","expirationTimeTemp","then","aToken","rToken","eTime","console","log","Object","keys","includes","accessTokenNew","access_token","refreshTokenNew","refresh_token","expiresInNew","expires_in","expirationTimeNew","userInfo","err","useEffect","logOutUser"],"sources":["/Users/paulgaudin/Desktop/r_cast/rcast_frontend/src/components/main.js"],"sourcesContent":["import { _storeData, _retrieveData } from \"../utils/storage\"\nimport { View } from 'react-native';\nimport * as React from 'react';\nimport { API_ENDPOINT } from \"../utils/constants\"\nimport axios from 'axios'\nimport UserNavigation from \"./userNavigation\";\n\nimport GuestNavigation from \"./guestNavigation\";\n\nimport { Button } from '@rneui/themed';\n\nimport { NavigationContainer } from '@react-navigation/native';\n\nimport {getUserInfo} from \"../API/getUserInfo\"\n\n\nconst getSpotifyCredentials = async () => {\n    const res = await axios.get(API_ENDPOINT + '/api/spotify-credentials')\n    const spotifyCredentials = res.data\n    return spotifyCredentials\n}\n\n\nconst refreshTokens = async (credentials, refreshToken) => {\n    const credsB64 = btoa(`${credentials.clientId}:${credentials.clientSecret}`);\n    const response = await fetch('https://accounts.spotify.com/api/token', {\n        method: 'POST',\n        headers: {\n            Authorization: `Basic ${credsB64}`,\n            'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: `grant_type=refresh_token&refresh_token=${refreshToken}`,\n    });\n    const responseJson = response.json();\n    return responseJson\n}\n\n\nexport default function Main() {\n\n\n\n\n    const [accessToken, setAccessToken] = React.useState('')\n    const [refreshToken, setRefreshToken] = React.useState('')\n    const [expirationTime, setExpirationTime] = React.useState(0)\n    const [loading, setLoading] = React.useState(true)\n\n\n    function isExpired(expTime) {\n        if (new Date().getTime() > expTime) {\n            return true\n        } else {\n            return false\n        }\n\n    }\n\n\n    const tokenRefreshWorkflow = () => {\n\n        try {\n            var accessTokenTemp = '';\n            var refreshTokenTemp = '';\n            var expirationTimeTemp = '';\n\n            _retrieveData('accessToken').then(aToken => {\n                accessTokenTemp = aToken\n                _retrieveData('refreshToken').then(rToken => {\n                    refreshTokenTemp = rToken\n                    _retrieveData('expirationTime').then(eTime => {\n                        expirationTimeTemp = eTime\n                        console.log(\"hi?\")\n                        if (accessTokenTemp && refreshTokenTemp && expirationTimeTemp) {\n                            console.log(\"muaahhh\")\n                            console.log(expirationTimeTemp)\n                            console.log(\"REFRESH\")\n                            console.log(refreshTokenTemp)\n\n                            if (isExpired(expirationTimeTemp)) {\n                                /// REFRESH TOKENS\n                                getSpotifyCredentials().then(credentials => {\n                                    refreshTokens(credentials, refreshTokenTemp).then(responseJson => {\n                                        console.log(\"Response JSON\")\n                                        console.log(responseJson)\n                                        if (Object.keys(responseJson).includes(\"expires_in\")) {\n                                            if (responseJson[\"expires_in\"]) {\n                                                const {\n                                                    access_token: accessTokenNew,\n                                                    refresh_token: refreshTokenNew,\n                                                    expires_in: expiresInNew,\n                                                } = responseJson;\n                                                const expirationTimeNew = new Date().getTime() + expiresInNew * 1000;\n                                                _storeData('accessToken', accessTokenNew);\n                                                _storeData('refreshToken', refreshTokenNew);\n                                                _storeData('expirationTime', expirationTimeNew);\n                                                setAccessToken(accessTokenTemp)\n                                                setRefreshToken(refreshTokenTemp)\n                                                setExpirationTime(expirationTimeTemp)\n                                                setLoading(false)\n                                                console.log(\"loading?\")\n                                                getUserInfo(accessTokenTemp).then(userInfo => {\n                                                    console.log(userInfo)\n                                                })\n                                                //  user workflow here \n                                                return true\n                                            }\n                                        } else {\n                                            setLoading(false)\n                                        }\n\n\n                                    })\n                                })\n\n                            } else {\n                                // user workflow here \n                                getUserInfo(accessTokenTemp).then(userInfo => {\n                                    console.log(userInfo)\n                                })\n                                if (accessTokenTemp !== accessToken) {\n                                    setAccessToken(accessTokenTemp)\n                                }\n                                if (refreshToken !== refreshTokenTemp) {\n                                    setRefreshToken(refreshTokenTemp)\n                                }\n                                if (expirationTime !== expirationTimeTemp) {\n                                    setExpirationTime(expirationTimeTemp)\n                                }\n                                setLoading(false)\n                                console.log(\"loading?\")\n                                return true\n                            }\n                        } else {\n                            setLoading(false)\n                        }\n\n                    })\n                });\n            });\n        } catch (err) {\n            setLoading(false)\n            return false\n        }\n\n    }\n\n    React.useEffect(() => {\n        console.log(\"MAIN USE EFFECT BEING CALLED\")\n        tokenRefreshWorkflow()\n    }, [])\n\n\n    const logOutUser = () => {\n        _storeData('accessToken', '');\n        _storeData('refreshToken', '');\n        _storeData('expirationTime', '');\n        setAccessToken('')\n        setRefreshToken('')\n        setExpirationTime(0)\n    }\n    return (\n        <NavigationContainer>\n\n            {accessToken && refreshToken && expirationTime && !loading &&\n\n\n                <UserNavigation\n                    logOutUser={logOutUser}\n                >\n                </UserNavigation>\n\n\n\n            }\n            {!accessToken && isExpired(expirationTime) && !loading &&\n                <GuestNavigation\n                    setAccessToken={setAccessToken}\n                    setRefreshToken={setRefreshToken}\n                    setExpirationTime={setExpirationTime}\n                >\n\n                </GuestNavigation>\n            }{loading &&\n                <View>\n                    <h1>Loading.....</h1>\n                </View>\n\n\n            }\n\n        </NavigationContainer>\n    )\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}